---
title: "Bayley Score and Food Security"
author: "Carter Allen"
date: "11/13/2018"
output: 
  pdf_document:
    toc: false
    toc_depth: 3
    includes:
      in_header: fig.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE,echo = FALSE,message = FALSE,warning = FALSE)
library(ggthemes)
library(ggplot2)
library(magrittr)
library(kableExtra)
library(knitr)
library(patchwork)
library(broom)
library(aod)
library(car)
library(tableone)
library(sas7bdat)
library(ggridges)
theme_set(theme_minimal(base_family = "serif"))
```

```{r,message=FALSE,warning=FALSE}
# Data pre-processing
source('~/Documents/School/Fall_2018/Research/Birth Outcomes & Clustering/process.R')
```

```{r}
nurt_quart <- read.csv("~/Documents/School/Fall_2018/Research/Birth Outcomes & Clustering/for_sas_set_quarterly.csv")
```

## Longitudinal Modeling of Bayley Scores

We wish to construct a longitudinal model of Bayley scores to assess the effect of food security status (either during pregnancy or during infancy) on infant development. The general form of the desired model is the following.

$$y_{ij} = \beta_0 + \mathbf{x}_{ij}'\stackrel{\rightarrow}{\beta_1}_{ij} + \beta_{2j}t_j +... + e_{ij}$$
$$e_{ij} \sim N_4(0,\mathbf{\Sigma}_{4 \times 4})$$


where $y_{ij}$ is the observed Bayley score for subject $i = 1,2,...,n$ at time $j = 1,2,3,4$. The global intercept is given by $\beta_0$. The effect of food security status (either two or three leveled) for subject $i$ at timepoint $j$ is given by $\stackrel{\rightarrow}{\beta_1}_{ij}$, and the effect of time $j$ is $\beta_{2j}$. We will also investigate possible interaction between food security status and time. The models will be fit under different structures for the covariance matrix $\mathbf{\Sigma}_{j \times j}$. 

## Model results

```{r}
out <- c("Bayley Composite","Bayley Percentile","Bayley Composite","Bayley Percentile","Bayley Composite","Bayley Percentile")
term <- c("Very low security","Very low security","Very low security","Very low security","Very low security","Very low security")
est <- c("-2.49","-5.30","-2.64","-5.80","-2.63","-5.79")
pval <- c("0.0811","0.0583","0.0834","0.0534","0.0837","0.0540")
aic <- c("13044","15360","10200","12009","10198","12005")
table <- as.data.frame(cbind(out,term,est,pval,aic))
colnames(table) <- c("Outcome","Term","Estimate","P-value","AIC")
kable(table, booktabs = T,caption = "Results from model with 2-level food security during pregnancy (Above very-low, Very-low). These models were also fit with an interaction term between food security status and time, which was found to be insignificant and therefore excluded from the model. Models were fit under an unstructured covariance matrix.") %>%
    kable_styling(position = "center",latex_options = c("striped","hold_position"),font_size = 11) %>%
    group_rows("Unadjusted",1,2) %>%
    group_rows("Adjusted (w/out WIC)",3,4) %>%
    group_rows("Adjusted (w/ WIC)",5,6)
```

```{r,fig.fullwidth = TRUE,fig.fullheight = TRUE,fig.cap="Mean plot"}
mean_plot_preg <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status_0) == FALSE) %>%
    group_by(timepoint,fdsec_status_0) %>%
    summarize(mean_bayley = mean(bayley_composite,na.rm = TRUE)) %>%
    ggplot(.,aes(x = timepoint, 
                 y = mean_bayley, 
                 group = fdsec_status_0, 
                 color = fdsec_status_0)) + 
    geom_point() +
    geom_line() + 
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during pregnancy") + 
    ylab("Mean Bayley Composite Score") + 
    xlab("Month") +
    ggtitle("Mean Bayley composite score over 1st year") + 
    labs(subtitle = "Grouped by food security status during pregnancy") +
    scale_x_continuous(breaks = c(3,6,9,12))
```

```{r,fig.fullwidth = TRUE,fig.fullheight = TRUE,fig.cap="Mean plot"}
mean_plot_preg2 <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status_0_isvlow) == FALSE) %>%
    group_by(timepoint,fdsec_status_0_isvlow) %>%
    summarize(mean_bayley = mean(bayley_composite,na.rm = TRUE)) %>%
    ggplot(.,aes(x = timepoint, 
                 y = mean_bayley, 
                 group = fdsec_status_0_isvlow, 
                 color = fdsec_status_0_isvlow)) + 
    geom_point() +
    geom_line() + 
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during pregnancy") + 
    ylab("Mean Bayley Composite Score") + 
    xlab("Month") +
    ggtitle("Mean Bayley composite score over 1st year") + 
    labs(subtitle = "Grouped by food security status during pregnancy")+
    scale_x_continuous(breaks = c(3,6,9,12))
```

```{r,fig.fullwidth = TRUE,fig.fullheight = TRUE,fig.cap="Mean plot"}
mean_plot_inf <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status) == FALSE) %>%
    group_by(timepoint,fdsec_status) %>%
    summarize(mean_bayley = mean(bayley_composite,na.rm = TRUE)) %>%
    ggplot(.,aes(x = timepoint, 
                 y = mean_bayley, 
                 group = fdsec_status, 
                 color = fdsec_status)) + 
    geom_point() +
    geom_line() + 
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during infancy") + 
    ylab("Mean Bayley Composite Score") + 
    xlab("Month") +
    ggtitle("Mean Bayley composite score over 1st year") + 
    labs(subtitle = "Grouped by food security status during infancy")+
    scale_x_continuous(breaks = c(3,6,9,12))
```

```{r,fig.fullwidth = TRUE,fig.fullheight = TRUE,fig.cap="Mean plot"}
mean_plot_inf2 <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status_isvlow) == FALSE) %>%
    group_by(timepoint,fdsec_status_isvlow) %>%
    summarize(mean_bayley = mean(bayley_composite,na.rm = TRUE)) %>%
    ggplot(.,aes(x = timepoint, 
                 y = mean_bayley, 
                 group = fdsec_status_isvlow, 
                 color = fdsec_status_isvlow)) + 
    geom_point() +
    geom_line() + 
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during infancy") + 
    ylab("Mean Bayley Composite Score") + 
    xlab("Month") +
    ggtitle("Mean Bayley composite score over 1st year") + 
    labs(subtitle = "Grouped by food security status during infancy")+
    scale_x_continuous(breaks = c(3,6,9,12))
```

```{r,fig.fullwidth = TRUE,fig.fullheight = TRUE,fig.cap="Mean plot"}
mean_plot_inf3 <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status_isvlow) == FALSE) %>%
    group_by(timepoint,fdsec_status_isvlow) %>%
    summarize(mean_bayley = mean(bayley_percentile,na.rm = TRUE)) %>%
    ggplot(.,aes(x = timepoint, 
                 y = mean_bayley, 
                 group = fdsec_status_isvlow, 
                 color = fdsec_status_isvlow)) + 
    geom_point() +
    geom_line() + 
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during infancy") + 
    ylab("Mean Bayley Percentile") + 
    xlab("Month") +
    ggtitle("Mean Bayley percentile over 1st year") + 
    labs(subtitle = "Grouped by food security status during infancy")+
    scale_x_continuous(breaks = c(3,6,9,12))
```

```{r}
ridge_plot_preg <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status_0) == FALSE) %>%
    ggplot(.,aes(x = bayley_composite,y = timepoint, group = timepoint,color = fdsec_status_0,fill = fdsec_status_0)) + 
    geom_density_ridges(alpha = 0.50,scale = 1) + 
    facet_wrap(~ fdsec_status_0, ncol = 1) +
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during pregnancy") +
    scale_fill_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during pregnancy") + 
    xlab("Bayley Score") + 
    ylab("Month") +
    ggtitle("Density of Bayley composite scores over first year") +
    labs(subtitle = "Grouped by food security status during pregnancy") +
    scale_y_continuous(breaks = c(3,6,9,12))
```

```{r}
ridge_plot_preg2 <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status_0_isvlow) == FALSE) %>%
    ggplot(.,aes(x = bayley_composite,y = timepoint, group = timepoint,color = fdsec_status_0_isvlow,fill = fdsec_status_0_isvlow)) + 
    geom_density_ridges(alpha = 0.50,scale = 1) + 
    facet_wrap(~ fdsec_status_0_isvlow, ncol = 1) +
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during pregnancy") +
    scale_fill_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during pregnancy") +
    xlab("Bayley Score") + 
    ylab("Month") +
    ggtitle("Density of Bayley composite scores over first year") +
    labs(subtitle = "Grouped by food security status during pregnancy")+
    scale_y_continuous(breaks = c(3,6,9,12))
```

```{r}
ridge_plot_inf  <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status) == FALSE) %>%
    ggplot(.,aes(x = bayley_composite,y = timepoint, group = timepoint,color = fdsec_status,fill = fdsec_status)) + 
    geom_density_ridges(alpha = 0.50,scale = 1) + 
    facet_wrap(~ fdsec_status, ncol = 1) +
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during infancy") +
    scale_fill_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during infancy") +
    xlab("Bayley Score") + 
    ylab("Month") +
    ggtitle("Density of Bayley composite scores over first year") +
    labs(subtitle = "Grouped by food security status during infancy")+
    scale_y_continuous(breaks = c(3,6,9,12))
```

```{r}
ridge_plot_inf  <- nurt_quart %>%
    filter(timepoint != 0,is.na(bayley_composite) == FALSE) %>%
    ggplot(.,aes(x = bayley_composite,y = timepoint, group = timepoint)) + 
    geom_density_ridges(alpha = 0.50,scale = 1) + 
    xlab(NULL) + 
    ylab("Month") +
    scale_y_continuous(breaks = c(3,6,9,12)) + 
    scale_x_continuous(breaks = seq(50,150,by = 25)) + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.text = element_text(size = 20, face = "bold"),
          axis.title = element_text(size = 20, face = "bold"),
          plot.title = element_text(size = 20, face = "bold"))
ggsave(plot = ridge_plot_inf,filename = "/Users/carter/Documents/School/Summer_2019/Research/MVSN-FMM/poster/bayley_dens.jpg",device = "jpg",dpi = 1000)
```


```{r}
ridge_plot_inf2 <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status_isvlow) == FALSE) %>%
    ggplot(.,aes(x = bayley_composite,y = timepoint, group = timepoint,color = fdsec_status_isvlow,fill = fdsec_status_isvlow)) + 
    geom_density_ridges(alpha = 0.50,scale = 1) + 
    facet_wrap(~ fdsec_status_isvlow, ncol = 1) +
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during infancy") + 
    scale_fill_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during infancy") +
    xlab("Bayley Score") + 
    ylab("Month") +
    ggtitle("Density of Bayley composite scores over first year") +
    labs(subtitle = "Grouped by food security status during infancy")+
    scale_y_continuous(breaks = c(3,6,9,12))
```

```{r}
profile_plot <- nurt_quart %>%
    filter(timepoint != 0,is.na(fdsec_status_0) == FALSE) %>%
    ggplot(.,aes(x = timepoint,y = bayley_composite, group = studyid, color = fdsec_status_0)) + 
    geom_point(alpha = 0.2) + 
    geom_line(alpha = 0.2) +
    facet_wrap(~ fdsec_status_0) + 
    ggtitle("Profile plots of Bayley composite score over 1st year") +
    labs(subtitle = "Faceted by food security during pregnancy") + 
    scale_color_manual(values = c("cadetblue","mediumseagreen","firebrick"),name = "Food security status \n during pregnancy")
```

## Mean Plots

```{r,fig.width=8,fig.height=8,fig.cap="Mean plot for Bayley composite scores grouped by three-leveled food security status during pregnancy."}
mean_plot_preg
```

```{r,fig.width=8,fig.height=8,fig.cap="Mean plot for Bayley composite scores grouped by two-leveled food security status during pregnancy."}
mean_plot_preg2
```

```{r,fig.width=8,fig.height=8,fig.cap="Mean plot for Bayley composite scores grouped by three-leveled food security status during infancy."}
mean_plot_inf
```

```{r,fig.width=8,fig.height=8,fig.cap="Mean plot for Bayley composite scores grouped by two-leveled food security status during infancy."}
mean_plot_inf2
```

## Density Plots

```{r,fig.width=8,fig.height=10,fig.cap="Density plot for Bayley composite scores grouped by three-leveled food security status during pregnancy."}
ridge_plot_preg
```

```{r,fig.width=8,fig.height=10,fig.cap="Density plot for Bayley composite scores grouped by two-leveled food security status during pregnancy."}
ridge_plot_preg2
```

```{r,fig.width=8,fig.height=10,fig.cap="Density plot for Bayley composite scores grouped by three-leveled food security status during infancy."}
ridge_plot_inf
```

```{r,fig.width=8,fig.height=10,fig.cap="Density plot for Bayley composite scores grouped by two-leveled food security status during infancy."}
ridge_plot_inf2
```

## Profile Plots

```{r,fig.width=9,fig.height=10,fig.cap="Profile plots"}
profile_plot
```





